<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Autenticación</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 0; }
        #root { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .header h1 { color: white; font-size: 24px; margin: 0; }
        .header-nav { display: flex; gap: 15px; align-items: center; }
        .header-link { color: white; text-decoration: none; padding: 8px 16px; border-radius: 6px; background: rgba(255, 255, 255, 0.2); cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 14px; }
        .header-link:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        .header-user { color: white; font-size: 14px; }
        
        .main-content { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); padding: 40px; width: 100%; max-width: 400px; }
        h2 { color: #667eea; margin-bottom: 25px; font-size: 24px; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #555; margin-bottom: 8px; font-weight: 500; }
        input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        button:active { transform: translateY(0); }
        button.secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        button.secondary:hover { background: #f5f5f5; }
        button.logout { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .message { padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .profile { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .profile h3 { color: #667eea; margin-bottom: 15px; }
        .profile-item { margin-bottom: 10px; color: #555; }
        .profile-item strong { color: #333; }
        .toggle-link { text-align: center; margin-top: 20px; color: #667eea; cursor: pointer; font-size: 14px; }
        .toggle-link:hover { text-decoration: underline; }
        .loading { text-align: center; color: #667eea; padding: 20px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const API_URL = 'http://localhost:8000';

        // ============================================
        // Módulo de Servicios de API
        // ============================================
        const AuthService = {
            // Registra un nuevo usuario
            async signup(nombre, email, password) {
                const response = await fetch(`${API_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, email, password })
                });
                return await response.json();
            },

            // Inicia sesión con email y contraseña
            async login(email, password) {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                return await response.json();
            },

            // Cierra la sesión del usuario actual
            async logout() {
                const response = await fetch(`${API_URL}/logout`, {
                    credentials: 'include'
                });
                return await response.json();
            },

            // Obtiene el perfil del usuario actual
            async getPerfil() {
                try {
                    const response = await fetch(`${API_URL}/perfil`, {
                        credentials: 'include'
                    });
                    if (response.ok) { return await response.json(); }
                    // Si el servidor responde con error (401, etc), no es un error de red
                    return null;
                } catch (error) {
                    // Solo errores de red llegan aquí
                    console.error('Error de red al obtener perfil:', error);
                    return null;
                }
            }
        };

        // ============================================
        // Componente Principal
        // ============================================
        function App() {
            // Estados: 'idle' | 'signup' | 'login' | 'logged'
            const [view, setView] = useState('idle');
            const [usuario, setUsuario] = useState(null);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState({ text: '', type: '' });

            useEffect(() => {
                verificarSesion();
            }, []);

            const verificarSesion = async () => {
                const perfil = await AuthService.getPerfil();
                if (perfil) {
                    setUsuario(perfil);
                    setView('logged');
                } else {
                    setView('login');
                }
                setLoading(false);
            };

            const handleSignup = async (e) => {
                e.preventDefault();
                setMessage({ text: '', type: '' });

                const formData = new FormData(e.target);
                const nombre   = formData.get('nombre');
                const email    = formData.get('email');
                const password = formData.get('password');

                try {
                    const result = await AuthService.signup(nombre, email, password);

                    if (result.error) {
                        setMessage({ text: result.error, type: 'error' });
                    } else {
                        setMessage({ text: result.message + ' Redirigiendo al login...', type: 'success' });
                        setTimeout(() => {
                            setView('login');
                            setMessage({ text: '', type: '' });
                        }, 2000);
                    }
                } catch (error) {
                    setMessage({ text: 'Error al conectar con el servidor', type: 'error' });
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setMessage({ text: '', type: '' });

                const formData = new FormData(e.target);
                const email    = formData.get('email');
                const password = formData.get('password');

                try {
                    const result = await AuthService.login(email, password);

                    if (result.error) {
                        setMessage({ text: result.error, type: 'error' });
                    } else {
                        // Obtener el perfil del usuario después de login exitoso
                        const perfil = await AuthService.getPerfil();
                        if (perfil) {
                            setUsuario(perfil);
                            setView('logged');
                            setMessage({ text: '', type: '' });
                        }
                    }
                } catch (error) {
                    setMessage({ text: 'Error al conectar con el servidor', type: 'error' });
                }
            };

            const handleLogout = async () => {
                try {
                    const result = await AuthService.logout();
                    setUsuario(null);
                    setView('idle');
                    setMessage({ text: '', type: '' });
                } catch (error) {
                    setMessage({ text: 'Error al cerrar sesión', type: 'error' });
                }
            };

            if (loading) {
                return (
                    <>
                        <div className="header">
                            <h1>Sistema de Autenticación</h1>
                        </div>
                        <div className="main-content">
                            <div className="container">
                                <div className="loading">Verificando sesión...</div>
                            </div>
                        </div>
                    </>
                );
            }

            return (
                <>
                    <div className="header">
                        <h1>Sistema de Autenticación</h1>
                        <div className="header-nav">
                            {view === 'idle' && (
                                <>
                                    <span 
                                        className="header-link" 
                                        onClick={() => {
                                            setView('login');
                                            setMessage({ text: '', type: '' });
                                        }}
                                    >
                                        Login
                                    </span>
                                    <span 
                                        className="header-link" 
                                        onClick={() => {
                                            setView('signup');
                                            setMessage({ text: '', type: '' });
                                        }}
                                    >
                                        Signup
                                    </span>
                                </>
                            )}
                            {view === 'logged' && usuario && (
                                <>
                                    <span className="header-user">
                                        👤 {usuario.nombre}
                                    </span>
                                    <span 
                                        className="header-link" 
                                        onClick={handleLogout} 
                                    >
                                        Logout
                                    </span>
                                </>
                            )}
                        </div>
                    </div>
                    
                    <div className="main-content">
                        {(view === 'signup' || view === 'login') && (
                            <div className="container">
                            {message.text && (
                                <div className={`message ${message.type}`}>
                                    {message.text}
                                </div>
                            )}

                    {view === 'login' && (
                        <>
                            <h2>Iniciar Sesión</h2>
                            <form onSubmit={handleLogin}>
                                <div className="form-group">
                                    <label htmlFor="email">Email:</label>
                                    <input
                                        type="email"
                                        id="email"
                                        name="email"
                                        required
                                        placeholder="tu@email.com"
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="password">Contraseña:</label>
                                    <input
                                        type="password"
                                        id="password"
                                        name="password"
                                        required
                                        placeholder="••••••••"
                                    />
                                </div>
                                <button type="submit">Iniciar Sesión</button>
                            </form>
                        </>
                    )}

                    {view === 'signup' && (
                        <>
                            <h2>Crear Cuenta</h2>
                            <form onSubmit={handleSignup}>
                                <div className="form-group">
                                    <label htmlFor="nombre">Nombre:</label>
                                    <input
                                        type="text"
                                        id="nombre"
                                        name="nombre"
                                        required
                                        placeholder="Tu nombre"
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="email">Email:</label>
                                    <input
                                        type="email"
                                        id="email"
                                        name="email"
                                        required
                                        placeholder="tu@email.com"
                                    />
                                </div>
                                <div className="form-group">
                                    <label htmlFor="password">Contraseña:</label>
                                    <input
                                        type="password"
                                        id="password"
                                        name="password"
                                        required
                                        placeholder="••••••••"
                                    />
                                </div>
                                <button type="submit">Registrarse</button>
                            </form>
                        </>
                    )}
                            </div>
                        )}
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
