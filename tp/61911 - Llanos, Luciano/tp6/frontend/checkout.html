<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TP6 Shop - Finalizar compra</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">TP6 Shop</a>
                <ul class="nav-links">
                    <li><a href="index.html">Productos</a></li>
                    <li><a href="carrito.html">Mis compras</a></li>
                    <li><a href="perfil.html" id="user-name">Juan Perez</a></li>
                    <li><a href="#" onclick="logout()">Salir</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="checkout-container">
        <h2 class="checkout-title">Finalizar compra</h2>
        
        <div id="alert-container"></div>

        <div class="checkout-sections">
            <!-- Resumen del carrito -->
            <div>
                <h3>Resumen del carrito</h3>
                <div id="cart-summary">
                    <!-- Items del carrito se cargarán aquí -->
                </div>
            </div>

            <!-- Datos de envío -->
            <div>
                <h3>Datos de envío</h3>
                <form id="checkout-form">
                    <div class="form-group">
                        <label for="direccion" class="form-label">Dirección</label>
                        <input 
                            type="text" 
                            id="direccion" 
                            class="form-input" 
                            required
                            placeholder="Av. Central 4124"
                        >
                    </div>

                    <div class="form-group">
                        <label for="ciudad" class="form-label">Ciudad</label>
                        <input 
                            type="text" 
                            id="ciudad" 
                            class="form-input" 
                            required
                            placeholder="Ciudad"
                        >
                    </div>

                    <div class="form-group">
                        <label for="codigo_postal" class="form-label">Código Postal</label>
                        <input 
                            type="text" 
                            id="codigo_postal" 
                            class="form-input" 
                            required
                            placeholder="1234"
                        >
                    </div>

                    <div class="form-group">
                        <label for="telefono" class="form-label">Teléfono</label>
                        <input 
                            type="tel" 
                            id="telefono" 
                            class="form-input" 
                            required
                            placeholder="1234567890"
                            minlength="10"
                        >
                    </div>

                    <h3 style="margin-top: 2rem;">Método de pago</h3>
                    
                    <div class="form-group">
                        <label for="metodo_pago" class="form-label">Método de pago</label>
                        <select id="metodo_pago" class="form-input" required>
                            <option value="">Selecciona método de pago</option>
                            <option value="tarjeta_credito">Tarjeta de crédito</option>
                            <option value="tarjeta_debito">Tarjeta de débito</option>
                            <option value="paypal">PayPal</option>
                            <option value="transferencia">Transferencia bancaria</option>
                        </select>
                    </div>

                    <div id="tarjeta-fields" class="hidden">
                        <div class="form-group">
                            <label for="numero_tarjeta" class="form-label">Número de tarjeta</label>
                            <input 
                                type="text" 
                                id="numero_tarjeta" 
                                class="form-input" 
                                placeholder="1234 5678 9012 3456"
                                maxlength="19"
                            >
                        </div>

                        <div class="form-group">
                            <label for="nombre_titular" class="form-label">Nombre del titular</label>
                            <input 
                                type="text" 
                                id="nombre_titular" 
                                class="form-input" 
                                placeholder="Juan Pérez"
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notas" class="form-label">Notas adicionales (opcional)</label>
                        <textarea 
                            id="notas" 
                            class="form-input" 
                            rows="3"
                            placeholder="Instrucciones especiales para la entrega..."
                        ></textarea>
                    </div>

                    <!-- Totales -->
                    <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
                        <div class="summary-row">
                            <span>Total productos:</span>
                            <span id="subtotal-productos">$572.05</span>
                        </div>
                        <div class="summary-row">
                            <span>IVA:</span>
                            <span id="iva-amount">$120.13</span>
                        </div>
                        <div class="summary-row">
                            <span>Envío:</span>
                            <span id="envio-amount">$30.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total a pagar:</span>
                            <span id="total-pagar">$742.18</span>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary" style="margin-top: 2rem; width: 100%;">
                        Confirmar compra
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8001';
        let currentUser = JSON.parse(localStorage.getItem('currentUser'));
        let cartData = null;

        document.addEventListener('DOMContentLoaded', function() {
            if (!currentUser || !currentUser.token) {
                window.location.href = 'login.html';
                return;
            }

            updateAuthUI();
            loadCartSummary();
            
            // Event listeners
            document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
            document.getElementById('metodo_pago').addEventListener('change', toggleTarjetaFields);
            document.getElementById('numero_tarjeta').addEventListener('input', formatCardNumber);
        });

        function updateAuthUI() {
            if (currentUser && currentUser.nombre) {
                document.getElementById('user-name').textContent = currentUser.nombre;
            }
        }

        async function loadCartSummary() {
            try {
                const response = await fetch(`${API_BASE}/carrito`, {
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });

                if (response.ok) {
                    cartData = await response.json();
                    renderCartSummary();
                    updateTotals();
                } else if (response.status === 401) {
                    logout();
                } else {
                    showAlert('Error al cargar el carrito', 'error');
                    setTimeout(() => window.location.href = 'carrito.html', 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión', 'error');
            }
        }

        function renderCartSummary() {
            const container = document.getElementById('cart-summary');
            
            if (!cartData || !cartData.items || cartData.items.length === 0) {
                container.innerHTML = '<p>El carrito está vacío</p>';
                return;
            }

            container.innerHTML = cartData.items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 500;">${item.producto_nombre}</div>
                        <div style="color: #666; font-size: 0.9rem;">Cantidad: ${item.cantidad}</div>
                    </div>
                    <div>
                        <div style="font-weight: 500;">$${item.subtotal.toFixed(2)}</div>
                        <div style="color: #666; font-size: 0.8rem;">($${item.precio_unitario.toFixed(2)} c/u)</div>
                    </div>
                </div>
            `).join('');
        }

        function updateTotals() {
            if (!cartData || !cartData.items) return;

            const subtotal = cartData.items.reduce((sum, item) => sum + item.subtotal, 0);
            const iva = subtotal * 0.21; // 21% IVA
            const envio = 30.00;
            const total = subtotal + iva + envio;

            document.getElementById('subtotal-productos').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva-amount').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('envio-amount').textContent = `$${envio.toFixed(2)}`;
            document.getElementById('total-pagar').textContent = `$${total.toFixed(2)}`;
        }

        function toggleTarjetaFields() {
            const metodoPago = document.getElementById('metodo_pago').value;
            const tarjetaFields = document.getElementById('tarjeta-fields');
            const numeroTarjeta = document.getElementById('numero_tarjeta');
            const nombreTitular = document.getElementById('nombre_titular');

            if (metodoPago === 'tarjeta_credito' || metodoPago === 'tarjeta_debito') {
                tarjetaFields.classList.remove('hidden');
                numeroTarjeta.required = true;
                nombreTitular.required = true;
            } else {
                tarjetaFields.classList.add('hidden');
                numeroTarjeta.required = false;
                nombreTitular.required = false;
            }
        }

        function formatCardNumber() {
            const input = document.getElementById('numero_tarjeta');
            let value = input.value.replace(/\D/g, ''); // Solo números
            value = value.replace(/(\d{4})(?=\d)/g, '$1 '); // Agregar espacios
            input.value = value;
        }

        async function handleCheckout(e) {
            e.preventDefault();

            const direccion = document.getElementById('direccion').value.trim();
            const ciudad = document.getElementById('ciudad').value.trim();
            const codigoPostal = document.getElementById('codigo_postal').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const metodoPago = document.getElementById('metodo_pago').value;
            const notas = document.getElementById('notas').value.trim();

            // Validaciones
            if (!direccion || !ciudad || !codigoPostal || !telefono || !metodoPago) {
                showAlert('Por favor completa todos los campos obligatorios', 'error');
                return;
            }

            if (telefono.length < 10) {
                showAlert('El teléfono debe tener al menos 10 dígitos', 'error');
                return;
            }

            // Datos adicionales para tarjetas
            let numeroTarjeta = '';
            let nombreTitular = '';
            
            if (metodoPago === 'tarjeta_credito' || metodoPago === 'tarjeta_debito') {
                numeroTarjeta = document.getElementById('numero_tarjeta').value.replace(/\s/g, '');
                nombreTitular = document.getElementById('nombre_titular').value.trim();
                
                if (!numeroTarjeta || !nombreTitular) {
                    showAlert('Por favor completa los datos de la tarjeta', 'error');
                    return;
                }
            }

            try {
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Procesando compra...';

                const checkoutData = {
                    direccion_entrega: {
                        direccion: direccion,
                        ciudad: ciudad,
                        codigo_postal: codigoPostal,
                        telefono: telefono
                    },
                    info_pago: {
                        metodo_pago: metodoPago,
                        numero_tarjeta: numeroTarjeta || null,
                        nombre_titular: nombreTitular || null
                    },
                    notas: notas || null
                };

                const response = await fetch(`${API_BASE}/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentUser.token}`
                    },
                    body: JSON.stringify(checkoutData)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('¡Compra realizada exitosamente!', 'success');
                    
                    // Guardar número de pedido para mostrar en historial
                    localStorage.setItem('lastOrderNumber', result.numero_pedido);
                    
                    setTimeout(() => {
                        window.location.href = 'historial.html';
                    }, 2000);
                    
                } else {
                    showAlert(result.detail || 'Error al procesar la compra', 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showAlert('Error de conexión. Intenta nuevamente.', 'error');
            } finally {
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Confirmar compra';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'error' ? 'alert-error' : 
                             type === 'success' ? 'alert-success' : 'alert-info';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            if (type === 'error') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>