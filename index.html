<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caja Registradora React</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #06b6d4;
      --muted: #e2e8f0;
      --danger: #ef4444;
      --success: #22c55e;
      --border: #1f2937;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: "Space Grotesk", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(6, 182, 212, 0.15), transparent 35%), radial-gradient(circle at 80% 10%, rgba(244, 63, 94, 0.12), transparent 30%), var(--bg);
      color: #f8fafc;
    }
    h1 {
      margin: 0 0 8px;
      font-weight: 700;
      letter-spacing: -0.03em;
    }
    p { margin: 4px 0 16px; color: #cbd5e1; }
    .shell {
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .scanner-box {
      height: 150px;
      width: 100%;
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(14, 165, 233, 0.05));
      border: 1px dashed rgba(226, 232, 240, 0.35);
      border-radius: 14px;
      overflow: hidden;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(6, 182, 212, 0.1);
      color: var(--accent);
      font-weight: 600;
      border: 1px solid rgba(6, 182, 212, 0.35);
      font-size: 13px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 960px) {
      .grid {
        grid-template-columns: 1.2fr 0.8fr;
        align-items: start;
      }
    }
    .input {
      width: 100%;
      padding: 12px 14px;
      background: #0b1221;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: #e2e8f0;
      font-size: 15px;
    }
    .input:focus { outline: 2px solid rgba(6, 182, 212, 0.4); }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      background: var(--accent);
      color: #0b1221;
      font-weight: 700;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.32);
    }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: #1e293b;
      color: #e2e8f0;
      box-shadow: none;
      border: 1px solid var(--border);
    }
    .list {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }
    .item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      padding: 12px;
      background: #0b1221;
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .item img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 10px;
      background: #020617;
      border: 1px solid var(--border);
    }
    .item-header { display: flex; gap: 10px; align-items: center; }
    .muted { color: #94a3b8; font-size: 13px; }
    .cart-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }
    .pill {
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      font-weight: 700;
      border: 1px solid rgba(34, 197, 94, 0.35);
      font-size: 13px;
    }
    small { color: #cbd5e1; }
    .error {
      color: var(--danger);
      margin-top: 6px;
      font-weight: 600;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9);
      color: #e2e8f0;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 14px;
      z-index: 50;
      min-width: 200px;
      text-align: center;
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useRef, useState, useMemo, useCallback } = React;

    const STORAGE_KEY = "caja-carrito";
    const THROTTLE_MS = 5000;

    const PRODUCT_DATA = [
      {
        "productId": "22668",
        "productName": "Gaseosa Dual Pack Coca Cola+Sprite 2.25L",
        "productTitle": "Gaseosa Dual Pack Coca Cola+Sprite 2.25L",
        "ean": "7790895006890",
        "price": 6136.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/181362/Foto-Producto.png.png?v=638818741668970000"
      },
      {
        "productId": "22799",
        "productName": "Gaseosa Coca Cola Lata 354Cc",
        "productTitle": "Gaseosa Coca Cola Lata 354Cc",
        "ean": "7790895000232",
        "price": 1560.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/181168/Foto-Producto.png.png?v=638785268822970000"
      },
      {
        "productId": "7043",
        "productName": "Gaseosa Pepsi   x 3000 Cc",
        "productTitle": "Gaseosa Pepsi   x 3000 Cc",
        "ean": "7791813555063",
        "price": 3387.29,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/174012/Gaseosa-Pepsi---x-3000-Cc.png?v=638146553631130000"
      },
      {
        "productId": "13991",
        "productName": "Gaseosa Coca Cola Promo 6x5 375 Cc",
        "productTitle": "Gaseosa Coca Cola Promo 6x5 375 Cc",
        "ean": "7790895008085",
        "price": 6749.6,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/182083/coca-cola_six_pack_375cc.png?v=638937950276700000"
      },
      {
        "productId": "6015",
        "productName": "Gaseosa Coca Cola Sin Azucar 1500 Cc",
        "productTitle": "Gaseosa Coca Cola Sin Azucar 1500 Cc",
        "ean": "7790895067556",
        "price": 3120.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/177188/45388.png?v=638453604730300000"
      },
      {
        "productId": "1955",
        "productName": "Gaseosa Coca Cola Sin Azucar 500 Cc",
        "productTitle": "Gaseosa Coca Cola Sin Azucar 500 Cc",
        "ean": "7790895067532",
        "price": 1560.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/181842/COCA_cola_sin_azucar_500ml.png?v=638908657543970000"
      },
      {
        "productId": "644",
        "productName": "Gaseosa Coca Cola  x 2250 Cc",
        "productTitle": "Gaseosa Coca Cola  x 2250 Cc",
        "ean": "7790895000997",
        "price": 4368.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/177182/4593.png?v=638453544458630000"
      },
      {
        "productId": "21697",
        "productName": "Gaseosa Fanta Limon Dulce 2500 Cc",
        "productTitle": "Gaseosa Fanta Limon Dulce 2500 Cc",
        "ean": "7790895648366",
        "price": 2600.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/179722/fan.png?v=638618383883700000"
      },
      {
        "productId": "6230",
        "productName": "Gaseosa Coca Cola Sin Azucar 2250 Cc",
        "productTitle": "Gaseosa Coca Cola Sin Azucar 2250 Cc",
        "ean": "7790895067570",
        "price": 4368.0,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/177189/51935.png?v=638453615670300000"
      },
      {
        "productId": "3840",
        "productName": "Gaseosa Pepsi x 354 Cc",
        "productTitle": "Gaseosa Pepsi x 354 Cc",
        "ean": "7791813555025",
        "price": 1245.99,
        "imageUrl": "https://alberdisa.vteximg.com.br/arquivos/ids/174050/Gaseosa-Pepsi-x-354-Cc.png?v=638146568606170000"
      }
    ];

    const money = (n) => new Intl.NumberFormat("es-AR", { style: "currency", currency: "ARS" }).format(n);

    const loadCarrito = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    };

    const saveCarrito = (items) => localStorage.setItem(STORAGE_KEY, JSON.stringify(items));

    const useProductos = () => {
      const [productos] = useState(PRODUCT_DATA);
      return { productos, loading: false, error: null };
    };

    function BarcodeScanner({ onEan }) {
      const videoRef = useRef(null);
      const [status, setStatus] = useState("init"); // init | active | unsupported | blocked | error
      const lastScanRef = useRef(0);

      useEffect(() => {
        let stream;
        let detector;
        let rafId;

        const setup = async () => {
          if (!("BarcodeDetector" in window)) {
            setStatus("unsupported");
            return;
          }
          try {
            detector = new BarcodeDetector({ formats: ["ean_13", "ean_8", "code_128", "code_39"] });
          } catch (e) {
            setStatus("unsupported");
            return;
          }

          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              await videoRef.current.play();
              setStatus("active");
              tick();
            }
          } catch (err) {
            setStatus(err.name === "NotAllowedError" ? "blocked" : "error");
          }
        };

        const tick = async () => {
          if (!videoRef.current || videoRef.current.readyState < 2) {
            rafId = requestAnimationFrame(tick);
            return;
          }
          try {
            const codes = await detector.detect(videoRef.current);
            if (codes && codes.length > 0) {
              const now = Date.now();
              const ean = codes[0].rawValue;
              if (ean && now - lastScanRef.current >= THROTTLE_MS) {
                lastScanRef.current = now;
                const event = new CustomEvent("ean-detected", { detail: { ean, at: now } });
                window.dispatchEvent(event);
                if (onEan) onEan(ean, "scanner");
              }
            }
          } catch (err) {
            console.error("Detector error", err);
          }
          rafId = requestAnimationFrame(tick);
        };

        setup();
        return () => {
          if (rafId) cancelAnimationFrame(rafId);
          if (stream) stream.getTracks().forEach((t) => t.stop());
        };
      }, [onEan]);

      const statusLabel = {
        init: "Inicializando cámara…",
        active: "Escanea un código EAN y espera 5s entre lecturas.",
        unsupported: "BarcodeDetector no disponible en este navegador.",
        blocked: "Permite el acceso a la cámara para escanear.",
        error: "No se pudo iniciar la cámara.",
      }[status];

      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div className="badge">Escáner EAN</div>
            <small>Intervalo mínimo: 5s</small>
          </div>
          <div className="scanner-box" style={{ marginTop: 12 }}>
            <video ref={videoRef} autoPlay playsInline muted />
          </div>
          <small>{statusLabel}</small>
        </div>
      );
    }

    function Buscador({ query, setQuery, onAddEan }) {
      return (
        <div className="panel">
          <div className="badge">Buscar / Ingresar EAN</div>
          <div className="row" style={{ marginTop: 10 }}>
            <input
              className="input"
              style={{ flex: 1, minWidth: 0 }}
              placeholder="Descripción o código EAN"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
            />
            <button className="btn" onClick={onAddEan}>Agregar EAN</button>
          </div>
          <small>Un solo campo para buscar o ingresar el EAN. El escáner también llena este flujo.</small>
        </div>
      );
    }

    function ListaProductos({ items, onAdd }) {
      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div className="badge">Resultados</div>
            <small>{items.length} mostrados (máx 5)</small>
          </div>
          <div className="list">
            {items.map((p) => (
              <div className="item" key={p.productId}>
                <div>
                  <div className="item-header">
                    <img src={p.imageUrl} alt={p.productName} />
                    <div>
                      <div>{p.productTitle}</div>
                      <div className="muted">EAN: {p.ean}</div>
                    </div>
                  </div>
                </div>
                <div style={{ display: "grid", gap: 6, justifyItems: "end" }}>
                  <div className="pill">{money(p.price)}</div>
                  <button className="btn secondary" onClick={() => onAdd(p)}>Agregar</button>
                </div>
              </div>
            ))}
            {items.length === 0 && <div className="muted">Sin coincidencias.</div>}
          </div>
        </div>
      );
    }

    function Carrito({ items, productos, onQty, onRemove }) {
      const enriched = items.map((it) => ({
        ...it,
        product: productos.find((p) => p.productId === it.productId),
      })).filter((i) => i.product);

      const total = enriched.reduce((sum, it) => sum + it.qty * (it.product ? (it.product.price || 0) : 0), 0);

      return (
        <div className="panel">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div className="badge">Carrito</div>
            <small>{enriched.length} items</small>
          </div>
          <div className="list">
            {enriched.map((it) => (
              <div className="item" key={it.productId}>
                <div>
                  <div>{it.product.productTitle}</div>
                  <div className="muted">EAN: {it.product.ean}</div>
                  <div className="muted">{money(it.product.price)} x {it.qty}</div>
                </div>
                <div style={{ display: "grid", gap: 6, justifyItems: "end" }}>
                  <div className="pill">{money(it.product.price * it.qty)}</div>
                  <div className="row">
                    <button className="btn secondary" onClick={() => onQty(it.productId, Math.max(1, it.qty - 1))}>-</button>
                    <button className="btn secondary" onClick={() => onQty(it.productId, it.qty + 1)}>+</button>
                    <button className="btn" style={{ background: "var(--danger)", boxShadow: "none" }} onClick={() => onRemove(it.productId)}>Quitar</button>
                  </div>
                </div>
              </div>
            ))}
            {enriched.length === 0 && <div className="muted">El carrito está vacío.</div>}
          </div>
          <div className="cart-summary">
            <div>Total</div>
            <div className="pill" style={{ background: "rgba(6, 182, 212, 0.12)", color: "#e0f2fe", borderColor: "rgba(14, 165, 233, 0.35)" }}>
              {money(total)}
            </div>
          </div>
        </div>
      );
    }

    function App() {
      const { productos, loading, error } = useProductos();
      const [query, setQuery] = useState("");
      const [carrito, setCarrito] = useState(() => loadCarrito());
      const [toast, setToast] = useState(null);
      const lastAutoAddRef = useRef(0);
      const toastTimerRef = useRef(null);
      const pdfBusyRef = useRef(false);

      const addToCart = useCallback((product) => {
        setCarrito((prev) => {
          const existing = prev.find((p) => p.productId === product.productId);
          if (existing) {
            return prev.map((p) => p.productId === product.productId ? { ...p, qty: p.qty + 1 } : p);
          }
          return [...prev, { productId: product.productId, qty: 1 }];
        });
      }, []);

      const showToast = useCallback((msg) => {
        if (toastTimerRef.current) clearTimeout(toastTimerRef.current);
        setToast(msg);
        toastTimerRef.current = setTimeout(() => setToast(null), 2800);
      }, []);

      const addFromEan = useCallback((ean, enforceThrottle = false) => {
        const product = productos.find((p) => p.ean === ean);
        if (!product) {
          showToast("EAN no encontrado");
          return;
        }
        if (enforceThrottle) {
          const now = Date.now();
          if (now - lastAutoAddRef.current < THROTTLE_MS) return;
          lastAutoAddRef.current = now;
        }
        addToCart(product);
      }, [productos, addToCart, showToast]);

      useEffect(() => {
        saveCarrito(carrito);
      }, [carrito]);

      useEffect(() => {
        const handler = (event) => {
          const ean = event.detail && event.detail.ean;
          if (ean) {
            setQuery(ean);
            addFromEan(ean, true);
          }
        };
        window.addEventListener("ean-detected", handler);
        return () => window.removeEventListener("ean-detected", handler);
      }, [addFromEan, setQuery]);

      const filtered = useMemo(() => {
        const base = !query.trim()
          ? productos
          : productos.filter((p) =>
              p.productTitle.toLowerCase().includes(query.toLowerCase()) ||
              p.productName.toLowerCase().includes(query.toLowerCase()) ||
              p.ean.includes(query)
            );
        return base.slice(0, 5);
      }, [query, productos]);

      const setQty = (productId, qty) => setCarrito((prev) => prev.map((p) => p.productId === productId ? { ...p, qty } : p));
      const removeItem = (productId) => setCarrito((prev) => prev.filter((p) => p.productId !== productId));

      const handleEanFromField = () => {
        const ean = query.trim();
        if (!ean) return;
        addFromEan(ean, false);
      };

      const generatePdf = useCallback(() => {
        if (pdfBusyRef.current) return;
        pdfBusyRef.current = true;
        try {
          if (!window.jspdf || !window.JsBarcode) {
            showToast("PDF no disponible en este navegador");
            return;
          }
          const doc = new window.jspdf.jsPDF();
          const pageHeight = doc.internal.pageSize.getHeight();
          let y = 20;
          productos.forEach((p) => {
            if (y + 40 > pageHeight) {
              doc.addPage();
              y = 20;
            }
            doc.setFontSize(12);
            doc.text(p.productTitle || p.productName, 14, y);
            doc.setFontSize(10);
            doc.text("EAN: " + p.ean, 14, y + 6);
            const canvas = document.createElement("canvas");
            try {
              window.JsBarcode(canvas, p.ean, { format: "EAN13", width: 1.2, height: 30, displayValue: false, margin: 0 });
            } catch (e) {
              window.JsBarcode(canvas, p.ean, { format: "CODE128", width: 1.2, height: 30, displayValue: false, margin: 0 });
            }
            const img = canvas.toDataURL("image/png");
            doc.addImage(img, "PNG", 120, y - 6, 70, 28);
            y += 42;
          });
          doc.save("productos.pdf");
        } catch (e) {
          console.error("PDF error", e);
          showToast("No se pudo generar el PDF");
        } finally {
          pdfBusyRef.current = false;
        }
      }, [productos, showToast]);

      return (
        <div className="shell">
          <div className="row" style={{ justifyContent: "space-between", alignItems: "center", gap: 12 }}>
            <div>
              <h1>Caja Registradora</h1>
              <p>Busca o ingresa el EAN en un solo campo, escanea con la cámara y guarda el carrito en tu dispositivo.</p>
            </div>
            <button className="btn secondary" onClick={generatePdf} style={{ whiteSpace: "nowrap" }}>Exportar PDF</button>
          </div>

          <BarcodeScanner onEan={(ean) => setQuery(ean)} />

          <div className="grid">
            <div className="panel" style={{ padding: 0 }}>
              <div style={{ padding: 16 }}>
                <Buscador query={query} setQuery={setQuery} onAddEan={handleEanFromField} />
                {loading && <div className="muted" style={{ padding: "0 16px 12px" }}>Cargando productos…</div>}
                {error && <div className="error" style={{ padding: "0 16px 12px" }}>{error}</div>}
              </div>
              <div style={{ padding: 16, paddingTop: 0 }}>
                <ListaProductos items={filtered} onAdd={addToCart} />
              </div>
            </div>
            <Carrito items={carrito} productos={productos} onQty={setQty} onRemove={removeItem} />
          </div>
          {toast && <div className="toast">{toast}</div>}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
